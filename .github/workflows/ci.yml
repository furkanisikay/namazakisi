# ========================================================================
# CI Pipeline â€” Namaz Akisi
# ========================================================================
#
# Tetikleyiciler:
#   - master / develop branch'lerine push
#   - master / develop branch'lerine PR
#
# Pipeline:
#   quality (lint + typecheck)  â”€â”€â”
#   test    (jest + coverage)   â”€â”€â”¼â”€â”€ ci-summary â”€â”€ auto-release (sadece master push)
#                                 â”‚
# ========================================================================

name: CI

on:
  push:
    branches: [master, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/ISSUE_TEMPLATE/**'
      - 'LICENSE'
  pull_request:
    branches: [master, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/ISSUE_TEMPLATE/**'
      - 'LICENSE'

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'

jobs:
  # =============================================
  # Kod Kalitesi Kontrolleri
  # =============================================
  quality:
    name: ğŸ” Kod Kalitesi
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ’¾ Cache node_modules
        id: cache-modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: ${{ runner.os }}-node-

      - name: ğŸ“š Install dependencies
        if: steps.cache-modules.outputs.cache-hit != 'true'
        run: npm ci

      - name: ğŸ”§ TypeScript
        id: typecheck
        run: npm run typecheck
        continue-on-error: true  # React 19 tip uyumsuzlugu nedeniyle gecici tolere ediliyor

      - name: ğŸ§¹ ESLint
        id: lint
        run: npm run lint

      - name: ğŸ“Š Kalite Ozeti
        if: always()
        run: |
          {
            echo "### ğŸ” Kod Kalitesi"
            echo ""
            echo "| Kontrol | Durum |"
            echo "|---------|-------|"
            echo "| TypeScript | ${{ steps.typecheck.outcome == 'success' && 'âœ… Basarili' || 'âš ï¸ Uyari (gecici tolere)' }} |"
            echo "| ESLint | ${{ steps.lint.outcome == 'success' && 'âœ… Basarili' || 'âŒ Basarisiz' }} |"
          } >> $GITHUB_STEP_SUMMARY

  # =============================================
  # Unit Testler
  # =============================================
  test:
    name: ğŸ§ª Testler
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ’¾ Cache node_modules
        id: cache-modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: ${{ runner.os }}-node-

      - name: ğŸ“š Install dependencies
        if: steps.cache-modules.outputs.cache-hit != 'true'
        run: npm ci

      - name: ğŸ§ª Testleri calistir
        id: tests
        run: npm test -- --coverage --coverageReporters=text --coverageReporters=lcov

      - name: ğŸ“Š Coverage artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

      - name: ğŸ“Š Test Ozeti
        if: always()
        run: |
          {
            echo "### ğŸ§ª Testler"
            echo ""
            echo "| Kontrol | Durum |"
            echo "|---------|-------|"
            echo "| Unit Tests | ${{ steps.tests.outcome == 'success' && 'âœ… Basarili' || 'âŒ Basarisiz' }} |"
            echo ""
            if [ -f coverage/lcov.info ]; then
              echo "> ğŸ“Š Coverage raporu artifact olarak yuklendi."
            fi
          } >> $GITHUB_STEP_SUMMARY

  # =============================================
  # Pipeline Ozeti
  # =============================================
  ci-summary:
    name: ğŸ“Š Pipeline Ozeti
    runs-on: ubuntu-latest
    needs: [quality, test]
    if: always()
    timeout-minutes: 2

    steps:
      - name: ğŸ“Š Ozet Raporu
        run: |
          {
            echo "## ğŸ“Š CI Pipeline Sonuclari"
            echo ""
            echo "| Job | Durum |"
            echo "|-----|-------|"
            echo "| ğŸ” Kod Kalitesi | ${{ needs.quality.result == 'success' && 'âœ… Basarili' || 'âŒ Basarisiz' }} |"
            echo "| ğŸ§ª Testler | ${{ needs.test.result == 'success' && 'âœ… Basarili' || 'âŒ Basarisiz' }} |"
            echo ""
            echo "---"
            echo ""
            echo "| Bilgi | Deger |"
            echo "|-------|-------|"
            echo "| **Branch** | \`${{ github.ref_name }}\` |"
            echo "| **Commit** | [\`${GITHUB_SHA::7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) |"
            echo "| **Tetikleyen** | @${{ github.actor }} |"
            echo "| **Olay** | \`${{ github.event_name }}\` |"
          } >> $GITHUB_STEP_SUMMARY
          
          # Tum sonuclari degerlendir
          if [ "${{ needs.quality.result }}" == "success" ] && [ "${{ needs.test.result }}" == "success" ]; then
            {
              echo ""
              echo "### âœ… Tum kontroller basarili!"
              if [ "${{ github.ref }}" == "refs/heads/master" ] && [ "${{ github.event_name }}" == "push" ]; then
                echo ""
                echo "> ğŸš€ **Release build otomatik olarak tetikleniyor...**"
              fi
            } >> $GITHUB_STEP_SUMMARY
          else
            {
              echo ""
              echo "### âŒ Pipeline basarisiz!"
              echo "> Release build tetiklenmeyecek."
            } >> $GITHUB_STEP_SUMMARY
          fi

      - name: âŒ Basarisiz sonuc
        if: needs.quality.result != 'success' || needs.test.result != 'success'
        run: exit 1

  # =============================================
  # Otomatik Release (master push + CI basarili)
  # =============================================
  auto-release:
    name: ğŸš€ Otomatik Release
    needs: [quality, test]
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    uses: ./.github/workflows/android-build.yml
    with:
      build_type: 'release'
    secrets: inherit
