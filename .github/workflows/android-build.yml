name: Android Build (Gradle)

# EAS kullanmadan, GitHub Actions uzerinden direkt Gradle ile APK build alir.
# Debug: Sadece APK olusturur
# Release: Semantic versioning + Changelog + GitHub Release + APK

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build tipi'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release


concurrency:
  group: android-build
  cancel-in-progress: true

permissions:
  contents: write

env:
  NODE_VERSION: '20'
  JAVA_VERSION: '17'
  use_debug_signing: 'false'

jobs:
  # ============================================
  # Debug Build - Sadece APK
  # ============================================
  debug-build:
    name: üîß Debug APK Build
    runs-on: ubuntu-latest
    timeout-minutes: 45
    if: ${{ inputs.build_type == 'debug' }}

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üî¢ Versiyon bilgisi al
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Versiyon: $VERSION"

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üíæ Cache node_modules
        id: cache-modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('package-lock.json') }}

      - name: ‚òï Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: üêò Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: wrapper
          cache-read-only: false

      - name: ü§ñ Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: üìö Install dependencies
        if: steps.cache-modules.outputs.cache-hit != 'true'
        run: npm ci

      - name: üîß Expo Prebuild
        run: npx expo prebuild --platform android --clean

      - name: ‚ö° Optimize Gradle properties
        run: |
          cat >> android/gradle.properties << 'EOF'

          # CI Build optimizations
          org.gradle.caching=true
          org.gradle.parallel=true
          org.gradle.configuration-cache=true
          org.gradle.configuration-cache.problems=warn
          org.gradle.jvmargs=-Xmx4g -XX:MaxMetaspaceSize=1g -XX:+HeapDumpOnOutOfMemoryError
          kotlin.daemon.jvmargs=-Xmx2g
          EOF

      - name: üèóÔ∏è Build Debug APK
        working-directory: android
        run: |
          chmod +x gradlew
          ./gradlew assembleDebug --no-daemon

      - name: üì¶ APK'yi yeniden adlandir
        id: rename
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TIMESTAMP=$(date +"%Y%m%d-%H%M%S")
          APK_NAME="NamazAkisi-v${VERSION}-debug-${TIMESTAMP}.apk"
          
          mv android/app/build/outputs/apk/debug/app-debug.apk "$APK_NAME"
          echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT

      - name: üì§ APK'yi Artifact olarak yukle
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.rename.outputs.apk_name }}
          path: ${{ steps.rename.outputs.apk_name }}
          retention-days: 3

      - name: üìä Build ozeti
        run: |
          {
            echo "### ‚úÖ Debug Build Basarili!"
            echo "---"
            echo "| Detay | Bilgi |"
            echo "|---|---|"
            echo "| ÔøΩ **APK Ismi** | \`${{ steps.rename.outputs.apk_name }}\` |"
            echo "| ÔøΩ **Boyut** | $(du -h ${{ steps.rename.outputs.apk_name }} | cut -f1) |"
            echo "| ‚è±Ô∏è **Tarih** | $(date '+%Y-%m-%d %H:%M:%S') |"
            echo ""
            echo "### üì• Nasil Indirilir?"
            echo "1. Yukaridaki **Artifacts** kismina gidin"
            echo "2. **${{ steps.rename.outputs.apk_name }}** dosyasina tiklayin"
          } >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Release Build - Versioning + Changelog + APK
  # ============================================
  release-build:
    name: üöÄ Release APK Build
    runs-on: ubuntu-latest
    timeout-minutes: 60
    if: ${{ inputs.build_type == 'release' }}

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üíæ Cache node_modules
        id: cache-modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('package-lock.json') }}

      - name: ‚òï Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: üêò Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: wrapper
          cache-read-only: false

      - name: ü§ñ Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: üìö Install dependencies
        if: steps.cache-modules.outputs.cache-hit != 'true'
        run: npm ci

      - name: üîß Kod kontrolleri
        run: |
          npm run typecheck || true
          npm run lint
          npm test

      # ============================================
      # Semantic Versioning
      # ============================================
      - name: üè∑Ô∏è Calculate Next Version
        id: version
        uses: paulhatch/semantic-version@v5.4.0
        with:
          tag_prefix: "v"
          major_pattern: "BREAKING CHANGE:"
          minor_pattern: "feat:"
          version_format: "${major}.${minor}.${patch}"
          search_commit_body: true
          user_format_type: "csv"

      - name: üìù Versiyon dosyalarini guncelle
        run: |
          NEW_VERSION="${{ steps.version.outputs.version }}"
          
          # package.json
          npm version $NEW_VERSION --no-git-tag-version
          
          # app.json
          node -e "
            const fs = require('fs');
            const appJson = JSON.parse(fs.readFileSync('./app.json', 'utf8'));
            appJson.expo.version = '$NEW_VERSION';
            
            // Auto increment Android versionCode
            if (!appJson.expo.android) appJson.expo.android = {};
            const currentCode = appJson.expo.android.versionCode || 0;
            appJson.expo.android.versionCode = currentCode + 1;
            console.log('Use new versionCode: ' + appJson.expo.android.versionCode);
            
            fs.writeFileSync('./app.json', JSON.stringify(appJson, null, 2) + '\n');
          "
          
          # UygulamaSabitleri.ts
          node -e "
            const fs = require('fs');
            const path = './src/core/constants/UygulamaSabitleri.ts';
            let content = fs.readFileSync(path, 'utf8');
            content = content.replace(/VERSIYON: '[0-9]+\.[0-9]+\.[0-9]+'/, \"VERSIYON: '$NEW_VERSION'\");
            fs.writeFileSync(path, content);
          "
          
          echo "‚úÖ Versiyon dosyalari guncellendi: $NEW_VERSION"

      # ============================================
      # Changelog Olustur (Repo'ya commit edilecek)
      # ============================================
      - name: üìÑ CHANGELOG.md guncelle
        run: |
          NEW_VERSION="${{ steps.version.outputs.version }}"
          TODAY=$(date +"%Y-%m-%d")
          LAST_TAG=$(git tag --sort=-version:refname | head -1)
          
          echo "üìù Changelog olusturuluyor..."
          echo "   Son tag: $LAST_TAG"
          
          # Yeni changelog entry
          {
            echo "# Deƒüi≈üiklik G√ºnl√ºƒü√º"
            echo ""
            echo "Bu dosyada projenin t√ºm √∂nemli deƒüi≈üiklikleri belgelenmi≈ütir."
            echo ""
            echo "Format [Keep a Changelog](https://keepachangelog.com/tr/1.0.0/) standardƒ±na dayanmaktadƒ±r."
            echo "[Semantik S√ºr√ºmleme](https://semver.org/lang/tr/) kullanƒ±lmaktadƒ±r."
            echo ""
            echo "## [${NEW_VERSION}] - ${TODAY}"
            echo ""
          } > CHANGELOG_NEW.md
          
          if [ -n "$LAST_TAG" ]; then
            # Eklendi (feat)
            FEATURES=$(git log ${LAST_TAG}..HEAD --no-merges --pretty=format:"%s" --grep="^feat" 2>/dev/null || true)
            if [ -n "$FEATURES" ]; then
              echo "### Eklendi" >> CHANGELOG_NEW.md
              git log ${LAST_TAG}..HEAD --no-merges --pretty=format:"- %s" --grep="^feat" 2>/dev/null | \
                sed 's/^- feat(\([^)]*\)): /- [\1] /' | \
                sed 's/^- feat: /- /' >> CHANGELOG_NEW.md
              echo "" >> CHANGELOG_NEW.md
              echo "" >> CHANGELOG_NEW.md
            fi
            
            # Duzeltildi (fix)
            FIXES=$(git log ${LAST_TAG}..HEAD --no-merges --pretty=format:"%s" --grep="^fix" 2>/dev/null || true)
            if [ -n "$FIXES" ]; then
              echo "### D√ºzeltildi" >> CHANGELOG_NEW.md
              git log ${LAST_TAG}..HEAD --no-merges --pretty=format:"- %s" --grep="^fix" 2>/dev/null | \
                sed 's/^- fix(\([^)]*\)): /- [\1] /' | \
                sed 's/^- fix: /- /' >> CHANGELOG_NEW.md
              echo "" >> CHANGELOG_NEW.md
              echo "" >> CHANGELOG_NEW.md
            fi
            
            # Degistirildi (refactor, perf)
            REFACTOR=$(git log ${LAST_TAG}..HEAD --no-merges --pretty=format:"%s" --grep="^refactor" 2>/dev/null || true)
            PERF=$(git log ${LAST_TAG}..HEAD --no-merges --pretty=format:"%s" --grep="^perf" 2>/dev/null || true)
            if [ -n "$REFACTOR" ] || [ -n "$PERF" ]; then
              echo "### Deƒüi≈ütirildi" >> CHANGELOG_NEW.md
              if [ -n "$REFACTOR" ]; then
                git log ${LAST_TAG}..HEAD --no-merges --pretty=format:"- %s" --grep="^refactor" 2>/dev/null | \
                  sed 's/^- refactor(\([^)]*\)): /- [\1] /' | \
                  sed 's/^- refactor: /- /' >> CHANGELOG_NEW.md
              fi
              if [ -n "$PERF" ]; then
                git log ${LAST_TAG}..HEAD --no-merges --pretty=format:"- %s" --grep="^perf" 2>/dev/null | \
                  sed 's/^- perf(\([^)]*\)): /- [\1] /' | \
                  sed 's/^- perf: /- /' >> CHANGELOG_NEW.md
              fi
              echo "" >> CHANGELOG_NEW.md
              echo "" >> CHANGELOG_NEW.md
            fi
          else
            echo "### üéâ ƒ∞lk S√ºr√ºm" >> CHANGELOG_NEW.md
            echo "" >> CHANGELOG_NEW.md
          fi
          
          # Eski changelog'u ekle
          if [ -f CHANGELOG.md ]; then
            tail -n +8 CHANGELOG.md >> CHANGELOG_NEW.md
          fi
          
          mv CHANGELOG_NEW.md CHANGELOG.md
          echo "‚úÖ CHANGELOG.md guncellendi"

      # ============================================
      # Release Notes Olustur (Sadece GitHub Release body icin)
      # ============================================
      - name: üìù Release Notes olustur
        id: release_notes
        run: |
          NEW_VERSION="${{ steps.version.outputs.version }}"
          TODAY=$(date +"%d %B %Y" | sed 's/January/Ocak/;s/February/Subat/;s/March/Mart/;s/April/Nisan/;s/May/Mayis/;s/June/Haziran/;s/July/Temmuz/;s/August/Agustos/;s/September/Eylul/;s/October/Ekim/;s/November/Kasim/;s/December/Aralik/')
          LAST_TAG=$(git tag --sort=-version:refname | head -1)
          
          # Release notes icerigi (repo'ya pushlanMAyacak, sadece body icin)
          NOTES=""
          
          if [ -n "$LAST_TAG" ]; then
            COMMIT_COUNT=$(git rev-list ${LAST_TAG}..HEAD --count 2>/dev/null || echo "0")
            NOTES="üìä **${COMMIT_COUNT}** commit | √ñnceki: [${LAST_TAG}](https://github.com/${{ github.repository }}/releases/tag/${LAST_TAG})"
            NOTES="${NOTES}\n\n"
            
            # Features
            FEATURES=$(git log ${LAST_TAG}..HEAD --no-merges --pretty=format:"- %s" --grep="^feat" 2>/dev/null | \
              sed 's/^- feat(\([^)]*\)): /- **\1**: /' | \
              sed 's/^- feat: /- /' || true)
            if [ -n "$FEATURES" ]; then
              NOTES="${NOTES}### ‚ú® Yeni √ñzellikler\n${FEATURES}\n\n"
            fi
            
            # Fixes
            FIXES=$(git log ${LAST_TAG}..HEAD --no-merges --pretty=format:"- %s" --grep="^fix" 2>/dev/null | \
              sed 's/^- fix(\([^)]*\)): /- **\1**: /' | \
              sed 's/^- fix: /- /' || true)
            if [ -n "$FIXES" ]; then
              NOTES="${NOTES}### üêõ Hata D√ºzeltmeleri\n${FIXES}\n\n"
            fi
            
            # Performance
            PERF=$(git log ${LAST_TAG}..HEAD --no-merges --pretty=format:"- %s" --grep="^perf" 2>/dev/null | \
              sed 's/^- perf(\([^)]*\)): /- **\1**: /' | \
              sed 's/^- perf: /- /' || true)
            if [ -n "$PERF" ]; then
              NOTES="${NOTES}### ‚ö° Performans\n${PERF}\n\n"
            fi
            
            # Refactor
            REFACTOR=$(git log ${LAST_TAG}..HEAD --no-merges --pretty=format:"- %s" --grep="^refactor" 2>/dev/null | \
              sed 's/^- refactor(\([^)]*\)): /- **\1**: /' | \
              sed 's/^- refactor: /- /' || true)
            if [ -n "$REFACTOR" ]; then
              NOTES="${NOTES}### ‚ôªÔ∏è Refactoring\n${REFACTOR}\n\n"
            fi
          else
            NOTES="üéâ **ƒ∞lk Release!**\n\n"
          fi
          
          # Multi-line output
          {
            echo "notes<<NOTES_EOF"
            echo -e "$NOTES"
            echo "NOTES_EOF"
          } >> $GITHUB_OUTPUT
          
          echo "previous_tag=$LAST_TAG" >> $GITHUB_OUTPUT



      # ============================================
      # APK Build
      # ============================================
      - name: üîß Expo Prebuild
        run: npx expo prebuild --platform android --clean

      - name: ‚ö° Optimize Gradle properties
        run: |
          cat >> android/gradle.properties << 'EOF'

          # CI Build optimizations
          org.gradle.caching=true
          org.gradle.parallel=true
          org.gradle.configuration-cache=true
          org.gradle.configuration-cache.problems=warn
          org.gradle.jvmargs=-Xmx4g -XX:MaxMetaspaceSize=1g -XX:+HeapDumpOnOutOfMemoryError
          kotlin.daemon.jvmargs=-Xmx2g
          EOF

      - name: üîê Keystore olustur
        run: |
          if [ -z "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
            echo "‚ö†Ô∏è Keystore bulunamadi, debug signing kullanilacak"
            echo "use_debug_signing=true" >> $GITHUB_ENV
          else
            echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/release.keystore
            echo "‚úÖ Keystore olusturuldu"
            echo "use_debug_signing=false" >> $GITHUB_ENV
          fi

      - name: üìù Gradle signing ayarlari
        if: env.use_debug_signing == 'false'
        run: |
          cat >> android/gradle.properties << EOF
          
          RELEASE_STORE_FILE=release.keystore
          RELEASE_STORE_PASSWORD=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          RELEASE_KEY_ALIAS=${{ secrets.ANDROID_KEY_ALIAS }}
          RELEASE_KEY_PASSWORD=${{ secrets.ANDROID_KEY_PASSWORD }}
          EOF

      - name: üîß Build.gradle signing config
        if: env.use_debug_signing == 'false'
        run: |

          cat << 'EOF' > update_signing.js
          const fs = require('fs');
          const path = 'android/app/build.gradle';
          let content = fs.readFileSync(path, 'utf8');

          // expo prebuild zaten signingConfigs { debug {...} } olusturur
          // Bu yuzden 'signingConfigs' yerine release-spesifik 'RELEASE_STORE_FILE' kontrolu yapiyoruz
          if (!content.includes('RELEASE_STORE_FILE')) {
            const releaseSigningConfig = `
              release {
                  if (project.hasProperty('RELEASE_STORE_FILE')) {
                      storeFile file(RELEASE_STORE_FILE)
                      storePassword RELEASE_STORE_PASSWORD
                      keyAlias RELEASE_KEY_ALIAS
                      keyPassword RELEASE_KEY_PASSWORD
                  }
              }
          `;
            if (content.includes('signingConfigs')) {
              // Mevcut signingConfigs bloguna release ekle
              content = content.replace(
                /(signingConfigs\s*\{)/,
                '$1' + releaseSigningConfig
              );
            } else {
              // Hic signingConfigs yoksa yeni blok olustur
              const signingConfig = `
          signingConfigs {
          ${releaseSigningConfig}}
          `;
              content = content.replace(/(android\s*\{)/, '$1' + signingConfig);
            }
          }

          if (!content.includes('signingConfig signingConfigs.release')) {
            content = content.replace(
              /(buildTypes\s*\{[\s\S]*?release\s*\{)/,
              '$1\n            signingConfig signingConfigs.release'
            );
          }

          fs.writeFileSync(path, content);
          console.log('‚úÖ build.gradle signing config guncellendi');
          EOF

          node update_signing.js
          rm update_signing.js

      - name: üèóÔ∏è Build Release APK
        working-directory: android
        run: |
          chmod +x gradlew
          ./gradlew assembleRelease --no-daemon

      - name: üì¶ APK'yi yeniden adlandir
        id: rename
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          APK_NAME="NamazAkisi-v${VERSION}.apk"

          # Release APK imzali ise app-release.apk, imzasiz ise app-release-unsigned.apk olur
          if [ -f "android/app/build/outputs/apk/release/app-release.apk" ]; then
            APK_SOURCE="android/app/build/outputs/apk/release/app-release.apk"
          elif [ -f "android/app/build/outputs/apk/release/app-release-unsigned.apk" ]; then
            APK_SOURCE="android/app/build/outputs/apk/release/app-release-unsigned.apk"
            APK_NAME="NamazAkisi-v${VERSION}-unsigned.apk"
          else
            echo "‚ùå APK dosyasi bulunamadi!"
            ls -la android/app/build/outputs/apk/release/ || true
            exit 1
          fi

          mv "$APK_SOURCE" "$APK_NAME"

          echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
          echo "apk_size=$(du -h $APK_NAME | cut -f1)" >> $GITHUB_OUTPUT

      # ============================================
      # Commit & Tag (Build basariliysa)
      # ============================================
      - name: üì§ Commit ve Tag olustur
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add package.json package-lock.json app.json src/core/constants/UygulamaSabitleri.ts CHANGELOG.md
          git commit -m "chore(release): ${{ steps.version.outputs.version }} [skip ci]"
          git tag -a ${{ steps.version.outputs.version_tag }} -m "Release ${{ steps.version.outputs.version_tag }}"
          git push origin HEAD:${{ github.ref_name }}
          git push origin ${{ steps.version.outputs.version_tag }}

      # ============================================
      # GitHub Release
      # ============================================
      - name: üöÄ GitHub Release olustur
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version_tag }}
          name: "üïå Namaz Akƒ±≈üƒ± v${{ steps.version.outputs.version }}"
          body: |
            ${{ steps.release_notes.outputs.notes }}
            ---
            
            ## üì± ƒ∞ndirme
            
            | Dosya | Boyut |
            |-------|-------|
            | ${{ steps.rename.outputs.apk_name }} | ${{ steps.rename.outputs.apk_size }} |
            
            ---
            
            üìÑ [T√ºm deƒüi≈üiklikler (CHANGELOG.md)](https://github.com/${{ github.repository }}/blob/${{ steps.version.outputs.version_tag }}/CHANGELOG.md)
            
            ${{ steps.release_notes.outputs.previous_tag != '' && format('üîó **Full Changelog**: https://github.com/{0}/compare/{1}...{2}', github.repository, steps.release_notes.outputs.previous_tag, steps.version.outputs.version_tag) || '' }}
          files: ${{ steps.rename.outputs.apk_name }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üìä Build ozeti
        run: |
          {
            echo "### üöÄ Release Build Basarili!"
            echo "---"
            echo "| Detay | Bilgi |"
            echo "|---|---|"
            echo "| üìå **Versiyon** | \`${{ steps.version.outputs.current_version }}\` ‚Üí \`${{ steps.version.outputs.version }}\` |"
            echo "| üè∑Ô∏è **Tag** | \`${{ steps.version.outputs.version_tag }}\` |"
            echo "| ÔøΩ **APK Ismi** | \`${{ steps.rename.outputs.apk_name }}\` |"
            echo "| ÔøΩ **Boyut** | ${{ steps.rename.outputs.apk_size }} |"
            echo ""
            echo "### üîó Baglantilar"
            echo "- [üì¶ Release Sayfasi](https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version_tag }})"
            echo "- [üìÑ Changelog](https://github.com/${{ github.repository }}/blob/${{ steps.version.outputs.version_tag }}/CHANGELOG.md)"
          } >> $GITHUB_STEP_SUMMARY
