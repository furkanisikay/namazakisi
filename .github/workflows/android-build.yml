# ========================================================================
# Android Build Pipeline (Gradle) ‚Äî Namaz Akisi
# ========================================================================
#
# Tetikleyiciler:
#   - Manuel (workflow_dispatch): Debug veya Release secimi
#   - CI'dan otomatik (workflow_call): master push basarili olunca
#
# Debug:   APK olusturur ‚Üí Artifact olarak yukler
# Release: Semantic Versioning ‚Üí Changelog ‚Üí Imzali APK ‚Üí GitHub Release
#
# ========================================================================

name: Android Build (Gradle)

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build tipi'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

  workflow_call:
    inputs:
      build_type:
        description: 'Build tipi'
        required: true
        default: 'release'
        type: string

concurrency:
  group: android-build-${{ inputs.build_type || 'debug' }}
  cancel-in-progress: true

permissions:
  contents: write

env:
  NODE_VERSION: '20'
  JAVA_VERSION: '17'

jobs:
  build:
    name: ${{ inputs.build_type == 'release' && 'üöÄ Release Build' || 'üîß Debug Build' }}
    runs-on: ubuntu-latest
    timeout-minutes: 60

    env:
      IS_RELEASE: ${{ inputs.build_type == 'release' }}

    steps:
      # ==========================================
      # Ortam Hazƒ±rlƒ±ƒüƒ±
      # ==========================================
      - name: ‚è±Ô∏è Zamanlayici
        id: timer
        run: echo "start=$(date +%s)" >> $GITHUB_OUTPUT

      - name: üì• Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: ${{ inputs.build_type == 'release' && 0 || 1 }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üíæ Cache node_modules
        id: cache-modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: ${{ runner.os }}-node-

      - name: ‚òï Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: üêò Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: wrapper
          cache-read-only: false

      - name: ü§ñ Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: üìö Install dependencies
        if: steps.cache-modules.outputs.cache-hit != 'true'
        run: npm ci

      # ==========================================
      # Kod Kontrolleri (Release)
      # ==========================================
      - name: üîß Kod kontrolleri
        if: inputs.build_type == 'release'
        run: |
          echo "üîß TypeScript kontrolu..."
          npm run typecheck || true
          echo "üßπ ESLint kontrolu..."
          npm run lint
          echo "üß™ Test kontrolu..."
          npm test

      # ==========================================
      # Versiyon Yonetimi (Release)
      # ==========================================
      - name: üî¢ Versiyon bilgisi (Debug)
        if: inputs.build_type == 'debug'
        id: debug_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Mevcut versiyon: $VERSION"

      - name: üè∑Ô∏è Semantic Versiyon Hesapla (Release)
        if: inputs.build_type == 'release'
        id: version
        uses: paulhatch/semantic-version@v5.4.0
        with:
          tag_prefix: "v"
          major_pattern: "BREAKING CHANGE:"
          minor_pattern: "feat:"
          version_format: "${major}.${minor}.${patch}"
          search_commit_body: true
          user_format_type: "csv"

      - name: üìù Versiyon dosyalarini guncelle (Release)
        if: inputs.build_type == 'release'
        run: |
          NEW_VERSION="${{ steps.version.outputs.version }}"
          
          # package.json
          npm version $NEW_VERSION --no-git-tag-version
          
          # app.json ‚Äî versiyon + versionCode
          node -e "
            const fs = require('fs');
            const appJson = JSON.parse(fs.readFileSync('./app.json', 'utf8'));
            appJson.expo.version = '$NEW_VERSION';
            if (!appJson.expo.android) appJson.expo.android = {};
            const currentCode = appJson.expo.android.versionCode || 0;
            appJson.expo.android.versionCode = currentCode + 1;
            console.log('versionCode: ' + appJson.expo.android.versionCode);
            fs.writeFileSync('./app.json', JSON.stringify(appJson, null, 2) + '\n');
          "
          
          # UygulamaSabitleri.ts
          node -e "
            const fs = require('fs');
            const path = './src/core/constants/UygulamaSabitleri.ts';
            let content = fs.readFileSync(path, 'utf8');
            content = content.replace(/VERSIYON: '[0-9]+\.[0-9]+\.[0-9]+'/, \"VERSIYON: '$NEW_VERSION'\");
            fs.writeFileSync(path, content);
          "
          
          echo "‚úÖ Tum dosyalar guncellendi: v$NEW_VERSION"

      # ==========================================
      # Changelog & Release Notes (Release)
      # ==========================================
      - name: üìÑ CHANGELOG.md guncelle (Release)
        if: inputs.build_type == 'release'
        run: |
          NEW_VERSION="${{ steps.version.outputs.version }}"
          TODAY=$(date +"%Y-%m-%d")
          LAST_TAG=$(git tag --sort=-version:refname | head -1)
          
          echo "üìù Changelog: $LAST_TAG ‚Üí v$NEW_VERSION"
          
          {
            echo "# Deƒüi≈üiklik G√ºnl√ºƒü√º"
            echo ""
            echo "Bu dosyada projenin t√ºm √∂nemli deƒüi≈üiklikleri belgelenmi≈ütir."
            echo ""
            echo "Format [Keep a Changelog](https://keepachangelog.com/tr/1.0.0/) standardƒ±na dayanmaktadƒ±r."
            echo "[Semantik S√ºr√ºmleme](https://semver.org/lang/tr/) kullanƒ±lmaktadƒ±r."
            echo ""
            echo "## [${NEW_VERSION}] - ${TODAY}"
            echo ""
          } > CHANGELOG_NEW.md
          
          if [ -n "$LAST_TAG" ]; then
            # Eklendi (feat)
            FEATURES=$(git log ${LAST_TAG}..HEAD --no-merges --pretty=format:"%s" --grep="^feat" 2>/dev/null || true)
            if [ -n "$FEATURES" ]; then
              echo "### Eklendi" >> CHANGELOG_NEW.md
              git log ${LAST_TAG}..HEAD --no-merges --pretty=format:"- %s" --grep="^feat" 2>/dev/null | \
                sed 's/^- feat(\([^)]*\)): /- [\1] /' | \
                sed 's/^- feat: /- /' >> CHANGELOG_NEW.md
              echo "" >> CHANGELOG_NEW.md
              echo "" >> CHANGELOG_NEW.md
            fi
            
            # Duzeltildi (fix)
            FIXES=$(git log ${LAST_TAG}..HEAD --no-merges --pretty=format:"%s" --grep="^fix" 2>/dev/null || true)
            if [ -n "$FIXES" ]; then
              echo "### D√ºzeltildi" >> CHANGELOG_NEW.md
              git log ${LAST_TAG}..HEAD --no-merges --pretty=format:"- %s" --grep="^fix" 2>/dev/null | \
                sed 's/^- fix(\([^)]*\)): /- [\1] /' | \
                sed 's/^- fix: /- /' >> CHANGELOG_NEW.md
              echo "" >> CHANGELOG_NEW.md
              echo "" >> CHANGELOG_NEW.md
            fi
            
            # Degistirildi (refactor, perf)
            REFACTOR=$(git log ${LAST_TAG}..HEAD --no-merges --pretty=format:"%s" --grep="^refactor" 2>/dev/null || true)
            PERF=$(git log ${LAST_TAG}..HEAD --no-merges --pretty=format:"%s" --grep="^perf" 2>/dev/null || true)
            if [ -n "$REFACTOR" ] || [ -n "$PERF" ]; then
              echo "### Deƒüi≈ütirildi" >> CHANGELOG_NEW.md
              if [ -n "$REFACTOR" ]; then
                git log ${LAST_TAG}..HEAD --no-merges --pretty=format:"- %s" --grep="^refactor" 2>/dev/null | \
                  sed 's/^- refactor(\([^)]*\)): /- [\1] /' | \
                  sed 's/^- refactor: /- /' >> CHANGELOG_NEW.md
              fi
              if [ -n "$PERF" ]; then
                git log ${LAST_TAG}..HEAD --no-merges --pretty=format:"- %s" --grep="^perf" 2>/dev/null | \
                  sed 's/^- perf(\([^)]*\)): /- [\1] /' | \
                  sed 's/^- perf: /- /' >> CHANGELOG_NEW.md
              fi
              echo "" >> CHANGELOG_NEW.md
              echo "" >> CHANGELOG_NEW.md
            fi
          else
            echo "### üéâ ƒ∞lk S√ºr√ºm" >> CHANGELOG_NEW.md
            echo "" >> CHANGELOG_NEW.md
          fi
          
          # Eski changelog'u ekle
          if [ -f CHANGELOG.md ]; then
            tail -n +8 CHANGELOG.md >> CHANGELOG_NEW.md
          fi
          
          mv CHANGELOG_NEW.md CHANGELOG.md
          echo "‚úÖ CHANGELOG.md guncellendi"

      - name: üìù Release Notes olustur (Release)
        if: inputs.build_type == 'release'
        id: release_notes
        run: |
          NEW_VERSION="${{ steps.version.outputs.version }}"
          LAST_TAG=$(git tag --sort=-version:refname | head -1)
          
          NOTES=""
          
          if [ -n "$LAST_TAG" ]; then
            COMMIT_COUNT=$(git rev-list ${LAST_TAG}..HEAD --count 2>/dev/null || echo "0")
            NOTES="üìä **${COMMIT_COUNT}** commit | √ñnceki: [${LAST_TAG}](https://github.com/${{ github.repository }}/releases/tag/${LAST_TAG})"
            NOTES="${NOTES}\n\n"
            
            # Features
            FEATURES=$(git log ${LAST_TAG}..HEAD --no-merges --pretty=format:"- %s" --grep="^feat" 2>/dev/null | \
              sed 's/^- feat(\([^)]*\)): /- **\1**: /' | \
              sed 's/^- feat: /- /' || true)
            if [ -n "$FEATURES" ]; then
              NOTES="${NOTES}### ‚ú® Yeni √ñzellikler\n${FEATURES}\n\n"
            fi
            
            # Fixes
            FIXES=$(git log ${LAST_TAG}..HEAD --no-merges --pretty=format:"- %s" --grep="^fix" 2>/dev/null | \
              sed 's/^- fix(\([^)]*\)): /- **\1**: /' | \
              sed 's/^- fix: /- /' || true)
            if [ -n "$FIXES" ]; then
              NOTES="${NOTES}### üêõ Hata D√ºzeltmeleri\n${FIXES}\n\n"
            fi
            
            # Performance
            PERF=$(git log ${LAST_TAG}..HEAD --no-merges --pretty=format:"- %s" --grep="^perf" 2>/dev/null | \
              sed 's/^- perf(\([^)]*\)): /- **\1**: /' | \
              sed 's/^- perf: /- /' || true)
            if [ -n "$PERF" ]; then
              NOTES="${NOTES}### ‚ö° Performans\n${PERF}\n\n"
            fi
            
            # Refactor
            REFACTOR=$(git log ${LAST_TAG}..HEAD --no-merges --pretty=format:"- %s" --grep="^refactor" 2>/dev/null | \
              sed 's/^- refactor(\([^)]*\)): /- **\1**: /' | \
              sed 's/^- refactor: /- /' || true)
            if [ -n "$REFACTOR" ]; then
              NOTES="${NOTES}### ‚ôªÔ∏è Refactoring\n${REFACTOR}\n\n"
            fi
          else
            NOTES="üéâ **ƒ∞lk Release!**\n\n"
          fi
          
          {
            echo "notes<<NOTES_EOF"
            echo -e "$NOTES"
            echo "NOTES_EOF"
          } >> $GITHUB_OUTPUT
          
          echo "previous_tag=$LAST_TAG" >> $GITHUB_OUTPUT

      # ==========================================
      # APK Build
      # ==========================================
      - name: üîß Expo Prebuild
        run: npx expo prebuild --platform android --clean

      - name: ‚ö° Gradle optimizasyonlari
        run: |
          cat >> android/gradle.properties << 'EOF'

          # CI Build optimizations
          org.gradle.caching=true
          org.gradle.parallel=true
          org.gradle.configuration-cache=true
          org.gradle.configuration-cache.problems=warn
          org.gradle.jvmargs=-Xmx4g -XX:MaxMetaspaceSize=1g -XX:+HeapDumpOnOutOfMemoryError
          kotlin.daemon.jvmargs=-Xmx2g
          EOF

      # ==========================================
      # Imzalama (Release)
      # ==========================================
      - name: üîê Keystore olustur (Release)
        if: inputs.build_type == 'release'
        run: |
          if [ -z "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
            echo "‚ö†Ô∏è Keystore bulunamadi, debug signing kullanilacak"
            echo "use_debug_signing=true" >> $GITHUB_ENV
          else
            echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/release.keystore
            echo "‚úÖ Keystore olusturuldu"
            echo "use_debug_signing=false" >> $GITHUB_ENV
          fi

      - name: üìù Gradle signing ayarlari (Release)
        if: inputs.build_type == 'release' && env.use_debug_signing == 'false'
        run: |
          cat >> android/gradle.properties << EOF
          
          RELEASE_STORE_FILE=release.keystore
          RELEASE_STORE_PASSWORD=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          RELEASE_KEY_ALIAS=${{ secrets.ANDROID_KEY_ALIAS }}
          RELEASE_KEY_PASSWORD=${{ secrets.ANDROID_KEY_PASSWORD }}
          EOF

      - name: üîß Build.gradle signing config (Release)
        if: inputs.build_type == 'release' && env.use_debug_signing == 'false'
        run: |
          cat << 'EOF' > update_signing.js
          const fs = require('fs');
          const path = 'android/app/build.gradle';
          let content = fs.readFileSync(path, 'utf8');

          if (!content.includes('RELEASE_STORE_FILE')) {
            const releaseSigningConfig = `
              release {
                  if (project.hasProperty('RELEASE_STORE_FILE')) {
                      storeFile file(RELEASE_STORE_FILE)
                      storePassword RELEASE_STORE_PASSWORD
                      keyAlias RELEASE_KEY_ALIAS
                      keyPassword RELEASE_KEY_PASSWORD
                  }
              }
          `;
            if (content.includes('signingConfigs')) {
              content = content.replace(
                /(signingConfigs\s*\{)/,
                '$1' + releaseSigningConfig
              );
            } else {
              const signingConfig = `
          signingConfigs {
          ${releaseSigningConfig}}
          `;
              content = content.replace(/(android\s*\{)/, '$1' + signingConfig);
            }
          }

          if (!content.includes('signingConfig signingConfigs.release')) {
            content = content.replace(
              /(buildTypes\s*\{[\s\S]*?release\s*\{)/,
              '$1\n            signingConfig signingConfigs.release'
            );
          }

          fs.writeFileSync(path, content);
          console.log('‚úÖ build.gradle signing config guncellendi');
          EOF

          node update_signing.js
          rm update_signing.js

      # ==========================================
      # Gradle Build
      # ==========================================
      - name: üèóÔ∏è Build APK
        working-directory: android
        run: |
          chmod +x gradlew
          if [ "${{ inputs.build_type }}" == "release" ]; then
            echo "üöÄ Release APK build ediliyor..."
            ./gradlew assembleRelease --no-daemon
          else
            echo "üîß Debug APK build ediliyor..."
            ./gradlew assembleDebug --no-daemon
          fi

      - name: üì¶ APK'yi yeniden adlandir
        id: rename
        run: |
          BUILD_TYPE="${{ inputs.build_type }}"
          
          if [ "$BUILD_TYPE" == "release" ]; then
            VERSION="${{ steps.version.outputs.version }}"
            APK_NAME="NamazAkisi-v${VERSION}.apk"
            
            if [ -f "android/app/build/outputs/apk/release/app-release.apk" ]; then
              APK_SOURCE="android/app/build/outputs/apk/release/app-release.apk"
            elif [ -f "android/app/build/outputs/apk/release/app-release-unsigned.apk" ]; then
              APK_SOURCE="android/app/build/outputs/apk/release/app-release-unsigned.apk"
              APK_NAME="NamazAkisi-v${VERSION}-unsigned.apk"
            else
              echo "‚ùå APK dosyasi bulunamadi!"
              ls -la android/app/build/outputs/apk/release/ || true
              exit 1
            fi
          else
            VERSION="${{ steps.debug_version.outputs.version }}"
            TIMESTAMP=$(date +"%Y%m%d-%H%M%S")
            APK_NAME="NamazAkisi-v${VERSION}-debug-${TIMESTAMP}.apk"
            APK_SOURCE="android/app/build/outputs/apk/debug/app-debug.apk"
          fi
          
          mv "$APK_SOURCE" "$APK_NAME"
          
          APK_SIZE=$(du -h "$APK_NAME" | cut -f1)
          echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
          echo "apk_size=$APK_SIZE" >> $GITHUB_OUTPUT
          echo "üì¶ $APK_NAME ($APK_SIZE)"

      # ==========================================
      # Debug: Artifact Upload
      # ==========================================
      - name: üì§ APK Artifact (Debug)
        if: inputs.build_type == 'debug'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.rename.outputs.apk_name }}
          path: ${{ steps.rename.outputs.apk_name }}
          retention-days: 3

      # ==========================================
      # Release: Commit, Tag, GitHub Release
      # ==========================================
      - name: üì§ Commit ve Tag (Release)
        if: inputs.build_type == 'release' && success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add package.json package-lock.json app.json src/core/constants/UygulamaSabitleri.ts CHANGELOG.md
          git commit -m "chore(release): ${{ steps.version.outputs.version }} [skip ci]"
          git tag -a ${{ steps.version.outputs.version_tag }} -m "Release ${{ steps.version.outputs.version_tag }}"
          git push origin HEAD:${{ github.ref_name }}
          git push origin ${{ steps.version.outputs.version_tag }}

      - name: üöÄ GitHub Release (Release)
        if: inputs.build_type == 'release' && success()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version_tag }}
          name: "üïå Namaz Akƒ±≈üƒ± v${{ steps.version.outputs.version }}"
          body: |
            ${{ steps.release_notes.outputs.notes }}
            ---
            
            ## üì± ƒ∞ndirme
            
            | Dosya | Boyut |
            |-------|-------|
            | ${{ steps.rename.outputs.apk_name }} | ${{ steps.rename.outputs.apk_size }} |
            
            ---
            
            üìÑ [T√ºm deƒüi≈üiklikler (CHANGELOG.md)](https://github.com/${{ github.repository }}/blob/${{ steps.version.outputs.version_tag }}/CHANGELOG.md)
            
            ${{ steps.release_notes.outputs.previous_tag != '' && format('üîó **Full Changelog**: https://github.com/{0}/compare/{1}...{2}', github.repository, steps.release_notes.outputs.previous_tag, steps.version.outputs.version_tag) || '' }}
          files: ${{ steps.rename.outputs.apk_name }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ==========================================
      # Build Ozeti
      # ==========================================
      - name: üìä Build Ozeti
        if: always()
        run: |
          END_TIME=$(date +%s)
          START_TIME="${{ steps.timer.outputs.start }}"
          DURATION=$((END_TIME - START_TIME))
          MINUTES=$((DURATION / 60))
          SECONDS=$((DURATION % 60))
          
          BUILD_TYPE="${{ inputs.build_type }}"
          
          if [ "$BUILD_TYPE" == "release" ]; then
            VERSION="${{ steps.version.outputs.version }}"
            TAG="${{ steps.version.outputs.version_tag }}"
          else
            VERSION="${{ steps.debug_version.outputs.version }}"
          fi
          
          {
            if [ "$BUILD_TYPE" == "release" ]; then
              echo "## üöÄ Release Build Sonucu"
            else
              echo "## üîß Debug Build Sonucu"
            fi
            echo ""
            echo "| Detay | Bilgi |"
            echo "|-------|-------|"
            echo "| üìå **Versiyon** | \`v${VERSION}\` |"
            
            if [ "$BUILD_TYPE" == "release" ] && [ -n "$TAG" ]; then
              echo "| üè∑Ô∏è **Tag** | \`${TAG}\` |"
            fi
            
            echo "| üì¶ **APK** | \`${{ steps.rename.outputs.apk_name }}\` |"
            echo "| üìè **Boyut** | ${{ steps.rename.outputs.apk_size }} |"
            echo "| ‚è±Ô∏è **Sure** | ${MINUTES}dk ${SECONDS}sn |"
            echo "| üåø **Branch** | \`${{ github.ref_name }}\` |"
            echo "| üìù **Commit** | [\`${GITHUB_SHA::7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) |"
            echo ""
            
            if [ "$BUILD_TYPE" == "release" ] && [ -n "$TAG" ]; then
              echo "### üîó Baglantilar"
              echo "- [üì¶ Release Sayfasi](https://github.com/${{ github.repository }}/releases/tag/${TAG})"
              echo "- [üìÑ Changelog](https://github.com/${{ github.repository }}/blob/${TAG}/CHANGELOG.md)"
            else
              echo "> üì• APK'yi yukaridaki **Artifacts** bolumunden indirebilirsiniz."
            fi
          } >> $GITHUB_STEP_SUMMARY
