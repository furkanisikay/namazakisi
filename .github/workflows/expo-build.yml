name: Expo Build (PlayStore)

# PlayStore icin EAS Build - Versiyon degistirmez!
# Mevcut versiyon ile Expo/EAS uzerinden build alir

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform'
        required: true
        default: 'android'
        type: choice
        options:
          - android
          - ios
          - all
      profile:
        description: 'Build profili'
        required: true
        default: 'production'
        type: choice
        options:
          - development
          - preview
          - production
      wait_for_build:
        description: 'Build tamamlanana kadar bekle'
        required: false
        default: false
        type: boolean

concurrency:
  group: expo-build
  cancel-in-progress: false

env:
  NODE_VERSION: '20'

jobs:
  build:
    name: ðŸš€ EAS Build
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”’ appVersionSource kontrolu
        run: |
          # eas.json'in appVersionSource degerini kontrol et
          APP_VERSION_SOURCE=$(node -p "require('./eas.json').cli?.appVersionSource || 'not-set'")
          
          if [ "$APP_VERSION_SOURCE" != "local" ]; then
            echo "âŒ HATA: eas.json'da appVersionSource '$APP_VERSION_SOURCE' olarak ayarli!"
            echo "   appVersionSource 'local' olmalidir."
            echo "   EAS remote versiyon yonetimi devre disi birakildi."
            echo ""
            echo "   Duzeltmek icin eas.json'da:"
            echo '   "cli": { "appVersionSource": "local" }'
            
            # Otomatik duzelt
            node -e "
              const fs = require('fs');
              const eas = JSON.parse(fs.readFileSync('./eas.json', 'utf8'));
              if (!eas.cli) eas.cli = {};
              eas.cli.appVersionSource = 'local';
              fs.writeFileSync('./eas.json', JSON.stringify(eas, null, 2) + '\n');
              console.log('âœ… appVersionSource otomatik olarak local yapildi');
            "
          else
            echo "âœ… appVersionSource: local (dogru)"
          fi

      - name: ðŸ”¢ Versiyon bilgisi
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          APP_VERSION=$(node -p "require('./app.json').expo.version")
          VERSION_CODE=$(node -p "require('./app.json').expo.android?.versionCode || 'yok'")
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "========================================"
          echo "ðŸ“¦ package.json Versiyon: $VERSION"
          echo "ðŸ“± app.json Versiyon: $APP_VERSION"
          echo "ðŸ”¢ app.json versionCode: $VERSION_CODE"
          echo "ðŸŽ¯ Platform: ${{ inputs.platform }}"
          echo "ðŸ“‹ Profil: ${{ inputs.profile }}"
          echo "ðŸ“Œ appVersionSource: local (app.json kullanilacak)"
          echo "========================================"
          
          if [ "$VERSION" != "$APP_VERSION" ]; then
            echo "âš ï¸ UYARI: package.json ($VERSION) ve app.json ($APP_VERSION) versiyonlari farkli!"
          fi

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸš€ Setup Expo
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ðŸ’¾ Cache node_modules
        id: cache-modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('package-lock.json') }}

      - name: ðŸ“š Install dependencies
        if: steps.cache-modules.outputs.cache-hit != 'true'
        run: npm ci

      - name: ðŸ” EXPO_TOKEN kontrolu
        run: |
          if [ -z "${{ secrets.EXPO_TOKEN }}" ]; then
            echo "âŒ EXPO_TOKEN bulunamadi!"
            echo "ðŸ’¡ GitHub Secrets'a EXPO_TOKEN eklediginizden emin olun."
            echo "   https://expo.dev/accounts/[account]/settings/access-tokens"
            exit 1
          fi
          echo "âœ… EXPO_TOKEN mevcut"

      # ============================================
      # Android Build
      # ============================================
      - name: ðŸ¤– Android Build
        if: ${{ inputs.platform == 'android' || inputs.platform == 'all' }}
        run: |
          echo "ðŸš€ Android EAS Build baslatiliyor..."
          echo "   Profil: ${{ inputs.profile }}"
          echo "   Versiyon: ${{ steps.version.outputs.version }}"
          
          if [ "${{ inputs.wait_for_build }}" == "true" ]; then
            eas build --platform android --profile ${{ inputs.profile }} --non-interactive
          else
            eas build --platform android --profile ${{ inputs.profile }} --non-interactive --no-wait
          fi
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      # ============================================
      # iOS Build
      # ============================================
      - name: ðŸŽ iOS Build
        if: ${{ inputs.platform == 'ios' || inputs.platform == 'all' }}
        continue-on-error: true
        run: |
          echo "ðŸš€ iOS EAS Build baslatiliyor..."
          echo "   Profil: ${{ inputs.profile }}"
          echo "   Versiyon: ${{ steps.version.outputs.version }}"
          
          if [ "${{ inputs.wait_for_build }}" == "true" ]; then
            eas build --platform ios --profile ${{ inputs.profile }} --non-interactive
          else
            eas build --platform ios --profile ${{ inputs.profile }} --non-interactive --no-wait
          fi
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: ðŸ“Š Build ozeti
        run: |
          {
            echo "### ðŸš€ EAS Build Baslatildi!"
            echo "---"
            echo "| Detay | Bilgi |"
            echo "|---|---|"
            echo "| ðŸ“¦ **Versiyon** | \`${{ steps.version.outputs.version }}\` |"
            echo "| ðŸŽ¯ **Platform** | \`${{ inputs.platform }}\` |"
            echo "| ðŸ“‹ **Profil** | \`${{ inputs.profile }}\` |"
            echo "| â³ **Bekleme** | \`${{ inputs.wait_for_build }}\` |"
            echo ""
            echo "### ðŸ”— Baglantilar"
            echo "- [ðŸ“± Expo Dashboard](https://expo.dev/accounts/${{ secrets.EXPO_ACCOUNT || 'furkanisikay' }}/projects/namazakisi/builds)"
            
            if [ "${{ inputs.wait_for_build }}" != "true" ]; then
              echo ""
              echo "> âš ï¸ **Not:** Build arka planda devam ediyor. Sonuclari Expo Dashboard uzerinden takip edebilirsiniz."
            fi
          } >> $GITHUB_STEP_SUMMARY
