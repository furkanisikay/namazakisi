# ========================================================================
# Expo Build Pipeline (PlayStore) â€” Namaz Akisi
# ========================================================================
#
# EAS Build ile PlayStore icin uretim APK/AAB olusturur.
# Versiyon DEGISTIRMEZ â€” mevcut app.json versiyonunu kullanir.
#
# Not: Versiyonlama android-build.yml tarafindan yonetilir.
#      Bu workflow sadece EAS uzerinden build almak icindir.
#
# ========================================================================

name: Expo Build (PlayStore)

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform'
        required: true
        default: 'android'
        type: choice
        options:
          - android
          - ios
          - all
      profile:
        description: 'Build profili'
        required: true
        default: 'production'
        type: choice
        options:
          - development
          - preview
          - production
      wait_for_build:
        description: 'Build tamamlanana kadar bekle'
        required: false
        default: false
        type: boolean

concurrency:
  group: expo-build-${{ inputs.platform }}-${{ inputs.profile }}
  cancel-in-progress: false

env:
  NODE_VERSION: '20'

jobs:
  build:
    name: ðŸš€ EAS Build (${{ inputs.platform }} / ${{ inputs.profile }})
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: â±ï¸ Zamanlayici
        id: timer
        run: echo "start=$(date +%s)" >> $GITHUB_OUTPUT

      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      # ==========================================
      # Versiyon Dogrulama
      # ==========================================
      - name: ðŸ”’ appVersionSource kontrolu
        run: |
          APP_VERSION_SOURCE=$(node -p "require('./eas.json').cli?.appVersionSource || 'not-set'")
          
          if [ "$APP_VERSION_SOURCE" != "local" ]; then
            echo "âš ï¸ appVersionSource '$APP_VERSION_SOURCE' â†’ 'local' olarak duzeltiliyor..."
            node -e "
              const fs = require('fs');
              const eas = JSON.parse(fs.readFileSync('./eas.json', 'utf8'));
              if (!eas.cli) eas.cli = {};
              eas.cli.appVersionSource = 'local';
              fs.writeFileSync('./eas.json', JSON.stringify(eas, null, 2) + '\n');
              console.log('âœ… appVersionSource: local');
            "
          else
            echo "âœ… appVersionSource: local"
          fi

      - name: ðŸ”¢ Versiyon bilgisi
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          APP_VERSION=$(node -p "require('./app.json').expo.version")
          VERSION_CODE=$(node -p "require('./app.json').expo.android?.versionCode || 'yok'")
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "app_version=$APP_VERSION" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          
          echo "ðŸ“¦ package.json: $VERSION | app.json: $APP_VERSION | versionCode: $VERSION_CODE"
          
          if [ "$VERSION" != "$APP_VERSION" ]; then
            echo "âš ï¸ UYARI: package.json ($VERSION) â‰  app.json ($APP_VERSION)"
          fi

      # ==========================================
      # Ortam HazÄ±rlÄ±ÄŸÄ±
      # ==========================================
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸš€ Setup Expo & EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ðŸ’¾ Cache node_modules
        id: cache-modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: ${{ runner.os }}-node-

      - name: ðŸ“š Install dependencies
        if: steps.cache-modules.outputs.cache-hit != 'true'
        run: npm ci

      - name: ðŸ” EXPO_TOKEN kontrolu
        run: |
          if [ -z "${{ secrets.EXPO_TOKEN }}" ]; then
            echo "âŒ EXPO_TOKEN bulunamadi!"
            echo "ðŸ’¡ GitHub Secrets > EXPO_TOKEN ekleyin."
            exit 1
          fi
          echo "âœ… EXPO_TOKEN mevcut"

      # ==========================================
      # EAS Build
      # ==========================================
      - name: ðŸ¤– Android Build
        if: inputs.platform == 'android' || inputs.platform == 'all'
        id: android_build
        run: |
          WAIT_FLAG=""
          if [ "${{ inputs.wait_for_build }}" != "true" ]; then
            WAIT_FLAG="--no-wait"
          fi
          
          eas build \
            --platform android \
            --profile ${{ inputs.profile }} \
            --non-interactive \
            $WAIT_FLAG
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: ðŸŽ iOS Build
        if: inputs.platform == 'ios' || inputs.platform == 'all'
        id: ios_build
        continue-on-error: true
        run: |
          WAIT_FLAG=""
          if [ "${{ inputs.wait_for_build }}" != "true" ]; then
            WAIT_FLAG="--no-wait"
          fi
          
          eas build \
            --platform ios \
            --profile ${{ inputs.profile }} \
            --non-interactive \
            $WAIT_FLAG
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      # ==========================================
      # Build Ozeti
      # ==========================================
      - name: ðŸ“Š Build Ozeti
        if: always()
        run: |
          END_TIME=$(date +%s)
          START_TIME="${{ steps.timer.outputs.start }}"
          DURATION=$((END_TIME - START_TIME))
          MINUTES=$((DURATION / 60))
          SECONDS=$((DURATION % 60))
          
          {
            echo "## ðŸš€ EAS Build Sonucu"
            echo ""
            echo "| Detay | Bilgi |"
            echo "|-------|-------|"
            echo "| ðŸ“¦ **Versiyon** | \`${{ steps.version.outputs.version }}\` |"
            echo "| ðŸ”¢ **versionCode** | \`${{ steps.version.outputs.version_code }}\` |"
            echo "| ðŸŽ¯ **Platform** | \`${{ inputs.platform }}\` |"
            echo "| ðŸ“‹ **Profil** | \`${{ inputs.profile }}\` |"
            echo "| â³ **Bekleme** | \`${{ inputs.wait_for_build }}\` |"
            echo "| â±ï¸ **Sure** | ${MINUTES}dk ${SECONDS}sn |"
            echo ""
            
            # Platform sonuclari
            echo "### Platform Sonuclari"
            echo ""
            echo "| Platform | Durum |"
            echo "|----------|-------|"
            
            if [ "${{ inputs.platform }}" == "android" ] || [ "${{ inputs.platform }}" == "all" ]; then
              echo "| ðŸ¤– Android | ${{ steps.android_build.outcome == 'success' && 'âœ… Basarili' || 'âŒ Basarisiz' }} |"
            fi
            
            if [ "${{ inputs.platform }}" == "ios" ] || [ "${{ inputs.platform }}" == "all" ]; then
              echo "| ðŸŽ iOS | ${{ steps.ios_build.outcome == 'success' && 'âœ… Basarili' || (steps.ios_build.outcome == 'skipped' && 'â­ï¸ Atlandi' || 'âŒ Basarisiz') }} |"
            fi
            
            echo ""
            echo "---"
            echo ""
            echo "### ðŸ”— Baglantilar"
            echo "- [ðŸ“± Expo Dashboard](https://expo.dev/accounts/${{ secrets.EXPO_ACCOUNT || 'furkanisikay' }}/projects/namazakisi/builds)"
            
            if [ "${{ inputs.wait_for_build }}" != "true" ]; then
              echo ""
              echo "> âš ï¸ Build arka planda devam ediyor. Expo Dashboard uzerinden takip edin."
            fi
          } >> $GITHUB_STEP_SUMMARY
